# Domain event (Доменное событие)

### Проблема

Как сервис публикует событие при обновлении своих данных?

### Решение

Агрегат публикует доменное событие во время своего создания или в ходе какого-то другого существенного изменения.

В контексте DDD доменное событие — это нечто произошедшее с агрегатом. В доменной модели оно имеет вид класса. Событие обычно представляет изменение состояния. При наличии заинтересованных потребителей агрегат может публиковать одно из этих событий в момент изменения своего состояния.

**Зачем публиковать события об изменениях**

- Обеспечение согласованности между сервисами с помощью повествований на основе хореографии
- Уведомление сервиса, который хранит реплику, об изменении в источнике дан­ных.
- Уведомление другого приложения через зарегистрированный веб-хук или брокер сообщений, чтобы инициировать следующий этап в бизнес-процессе.
- Уведомление другого компонента того же приложения, чтобы, к примеру, послать браузеру пользователя сообщение через WebSocket или обновить текстовую базу данных, такую как ElasticSearch.
- Рассылка пользователям уведомлений (текстовых сообщений или электронных писем) об отправке их заказа, готовности медицинского рецепта или задержке самолета.
- Мониторинг доменных событий для проверки корректности поведения системы.
- Анализ событий для моделирования поведения пользователя.

**Что такое доменное событие**

*Доменное событие —* это класс с именем на основе страдательного причастия про­шедшего времени (OrderCreated). Он содержит свойства, которые выразительно передают это со­бытие. Каждое свойство представляет собой либо простое значение, либо объект.

У доменного события обычно есть метаданные, такие как его идентификатор и временная метка. Оно может нести в себе идентификатор пользователя, который сделал изменение, поскольку это полезно для аудита. Метаданные могут быть частью
объекта события. Или же они могут находиться внутри обертки вокруг объекта события. Идентификатор агре­гата, который сгенерировал событие, тоже может быть не его непосредственным свойством, а частью обертки.

**Обогащение события**

*Обогащение событий —* это когда события содержат информацию, которая нужна потребителю. В результате потре­бители событий становятся более простыми, поскольку им больше не нужно запра­шивать данные у сервиса, опубликовавшего событие.

Обогащение событий упрощает потребителей, но его обратной стороной являет­ся риск снижения стабильности классов событий. Эти классы потенциально могут меняться каждый раз, когда обновляются требования их потребителей. Это способно отрицательно сказаться на поддерживаемое TM, поскольку изменения такого рода мо­гут затронуть несколько частей приложения. К тому же удовлетворение требований каждого потребителя может оказаться недостижимой целью.

**Определение доменных событий**

- Cценарии, в которых необходимы уведомления, описываются в требованиях к при­ложению («Если произойдет X, сде­ лайте У»).
- *Event storming (Событийный штурм) —* это формат собрания для обсуждения сложного домена, сосредоточенный вокруг событий. Специалисты в предметной области соби­раются в комнате с большой доской для рисования или рулоном бумаги, куда будут
крепиться небольшие записки. Результатом этого процесса становится событийная доменная модель, состоящая из агрегатов и событий.
Событийный штурм имеет три этапа:
    1. *Интенсивное определение событий.* Специалистов в проблемной области просят определить доменные события. Это будет выглядеть как цепочка из оранжевых записок, выложенная на поверхности для моделирования.
    2. *Определение причин событий.* Специалистов в проблемной области просят опре­делить причину каждого события, которая может быть одной из следующих:
        1. действие пользователя (представлено в виде команды на синей записке);
        2. внешняя система (фиолетовая записка);
        3. другое доменное событие;
        4. истечение времени.
    3. *Определение агрегатов.* Специалистов в проблемной области просят определить агрегат, который потребляет каждую команду и генерирует соответствующее со­бытие. Агрегаты представлены в виде желтых записок.
    
    ![Untitled](Domain%20event%20(%D0%94%D0%BE%D0%BC%D0%B5%D0%BD%D0%BD%D0%BE%D0%B5%20%D1%81%D0%BE%D0%B1%D1%8B%D1%82%D0%B8%D0%B5)/Untitled.png)
    

**Генерация и публикация доменных событий**

Взаимодействие с помощью доменных событий — это разновидность асинхронного обмена сообщениями.

Варианты:

1. На концептуальном уровне доменные события публикуются агрегатами. Агрегат знает, когда меняется его состояние и, следовательно, какое событие нужно опубли­ ковать. Агрегат может обращаться непосредственно к API для обмена сообщениями. Недостаток этого подхода связан с тем, что агрегат не поддерживает внедрение за­висимостей, из-за чего API для обмена сообщениями придется передавать в метод в виде аргумента. Это приведет к переплетению инфраструктуры и бизнес-логики, что крайне нежелательно.
2. Более подходящим подходом будет разделение ответственности между агрегатом и сервисом (или эквивалентным классом), который к нему обращается. Сервисы могут использовать внедрение зависимостей для получения ссылки на API для обмена сообщениями, что позволяет им легко публиковать события. Агрегат генери­рует события при изменении своего состояния и возвращает их сервису.
3. Накапливать события в поле корня агрегата. После этого сервис извлекает эти события и публикует их.

**Надежная публикация доменных событий**

Чтобы события публиковались как часть транзакции, которая обновляет агрегат в базе данных, сервис должен использовать транзакционный обмен сообщениями.

**Потребление доменных событий**

В конечном счете доменные события доходят до брокера (например, Apache Kafka) в виде сообщений. Потребитель может напрямую воспользоваться клиентским API брокера.

### Преимущества

### Недостатки