# Serverless deployment (Бессерверное развертывание)

# Проблема

Как упаковываются и развертываются сервисы?

Пакеты, рассчитанные на определенные языки, виртуальные маши­ны и контейнеры довольно сильно различаются, но у всех них есть и общее. Во-первых, все эти шаблоны развертывания должны заранее выделять определенные вычислительные ресурсы — физические серверы, виртуальные машины или контейнеры. Некоторые платформы развертывания поддерживают автомасштабирование, динамически регулируя количество ВМ или контейнеров в зависимости от нагрузки. Тем не менее вам постоянно нужно платить за какие-то ресурсы, даже если они простаивают.

Еще одной общей чертой является то, что ответственность за системное адми­нистрирование ложится на вас. С каким бы сервером вы ни работали, его опера­ционную систему нужно обновлять. Если это физические серверы, их необходимо распределять по стойкам. Вы также отвечаете за обслуживание среды выполнения языка программирования. Это то, что компания Amazon называет неразделяемой рутинной работой. С первых дней возникновения компьютерной индустрии систем­ ное администрирование было тем, без чего нельзя обойтись. Но, как оказывается, у этого правила есть исключение — бессерверные платформы.

# Решение

Развёртывает сервисы с помощью бессерверного механизма, предоставляемого публичным облаком.

Используйте инфраструктуру развертывания, которая скрывает любую концепцию серверов (т. е. зарезервированных или заранее выделенных ресурсов) - физических или виртуальных хостов или контейнеров. Инфраструктура берет код вашего сервиса и запускает его. За каждый запрос взимается плата в зависимости от потребленных ресурсов. Чтобы развернуть сервис с помощью этого подхода, вы упаковываете код (например, в ZIP-файл), загружаете его в инфраструктуру развертывания и описываете желаемые характеристики производительности. Инфраструктура развертывания - это утилита, управляемая провайдером публичного облака. Обычно она использует контейнеры или виртуальные машины для изоляции сервисов. Однако эти детали скрыты от вас. Ни вы, ни кто-либо другой в вашей организации не отвечает за управление низкоуровневой инфраструктурой, такой как операционные системы, виртуальные машины и т. д.

На конференции AWS Reinvent 2014 Вернер Вогельс (Werner Vogels), техниче­ский директор Amazon, в ходе представления AWS Lambda произнес потрясающую фразу: «На пересечении функций, событий и данных происходит магия». Как мож­но догадаться из этих слов, платформа AWS Lambda изначально предназначалась для развертывания сервисов с событийной моделью, а «магической» ее делает то, что это пример технологии бессерверного развертывания.

Все основные публичные облака предоставляют возможность бессерверного развёртывания:

- AWS Lambda
- Google Cloud Functions в Google Cloud
- Azure Functions в Microsoft Azure

AWS Lambda поддерживает Java, NodeJS, С#, GoLang и Python. 

*Лямбда-функ­ция —* это сервис, лишенный состояния. Для обработки запросов она обычно об­ращается к сервисам AWS. Например, лямбда-функция, которая срабатывает при загрузке изображения в облако S3, вставляет элемент в таблицу IMAGES DynamoDB и публикует сообщение в Kinesis, чтобы инициировать обработку этого изображения. Лямбда-функция также может вызывать сторонние веб-сервисы.

Чтобы развернуть сервис, нужно упаковать его в файл ZIP или JAR, загру­зить в AWS Lambda и указать имя функции, которая будет вызываться для об­работки запроса (который еще называют *событием).* AWS Lambda автоматически следит за тем, чтобы экземпляров вашего микросервиса было достаточно для об­работки входящих запросов. Вы платите за каждый запрос с учетом потраченного времени и потребленной памяти. Конечно, дьявол кроется в деталях, и позже вы увидите, что AWS Lambda имеет ограничения. Ни вы, как разра­ботчик, ни кто-нибудь другой в вашей организации не должны волноваться о ка­ких-либо аспектах серверов, виртуальных машин или контейнеров.

## **Написание лямбда-функции**

В отличие от других шаблонов лямбда-функции требуют использования особой модели разработки. Их код и формат упаковывания зависят от языка про­граммирования. В Java лямбда-функция представляет собой класс, реализующий обобщенный интерфейс RequestHandler, который определен в основной библиотеке AWS LambdaJava. Этот интерфейс принимает параметры двух типов: I — тип ввода и O — тип вывода. Они зависят от того, какого рода запросы обраба­тывает лямбда-функция.

**Листинг 12,8.** В Java лямбда-функция является классом, который реализует
интерфейс RequestHandler

```java
public interface RequestHandler<I, O> {
	public O handleRequest(I input, Context context);
}
```

Интерфейс RequestHandler определяет единственный метод — handleRequest(). У него есть два параметра — входящий объект и контекст, который предоставляет доступ к среде выполнения Lambda, например к ID запроса. В качестве результа­та возвращается исходящий объект. У лямбда-функций, которые обрабатывают HTTP-запросы, проходящие через API-шлюз AWS, в качестве I и O используются типы APIGatewayProxyRequestEvent и APIGatewayProxyResponseEvent соответствен­но.

В Java лямбда-функции упаковываются в файлы ZIP или JAR.

## **Вызов лямбда-функций**

Лямбда-функцию можно вызвать четырьмя способами:

- **C помощью НТТР-запросов.**
Вы можете сконфигурировать API-шлюз AWS таким образом, чтобы он направлял HTTP-запросы к вашей лямбда-функции. Она будет доступна по протоколу HTTPS в виде конечной точки. API-шлюз играет роль HTTP-прокси, он передает лямбда-функции объект внутри HTTP-запроса и ожидает получения от нее НТТР-ответа. Использование API-шлюза в сочетании с AWS Lambda позволяет, к примеру, раз­вертывать RESTful-сервисы в виде лямбда-функций.
- **Посредством событий, генерируемых сервисами AWS.**
Лямбда-функцию можно сконфигурировать для обработки событий, генерируемых сервисом AWS. Примеры событий, которые могут привести к срабатыванию лямб­да-функции:
    - в бакете S3 создан объект;
    - в таблице DynamoDB создан, обновлен или удален элемент;
    - в потоке Kinesis появилось сообщение, доступное для чтения;
    - с помощью Simple Email Service получено электронное письмо.
- **Как запланированные вызовы.**
Для вызова лямбда-функции можно также использовать механизм планирования Linux в стиле cron. Вы можете сконфигурировать ее для периодических вызовов, например, раз в минуту, три часа или семь дней. Для этого также предусмотрены выражения в формате cron, которые определяют, когда платформа AWS должна вызвать вашу лямбда-функцию. Эти выражения чрезвычайно гибки.
- **Напрямую с помощью API-вызовов.**
Четвертый способ вызова лямбда-функций заключается в использовании веб­-сервисов вашего приложения. Веб-сервис указывает в своем запросе имя лямбда-функции и данные входящего события. Ваше приложение может делать синхронные и асинхронные вызовы. В первом случае ответ лямбда-функции будет содержаться в HTTP-ответе веб-сервиса. Если же вызов сделан асинхронно, ответ веб-сервиса сигнализирует о том, был ли успешным запуск лямбда-функции.

## **Развертывание RESTful-сервиса с помощью AWS Lambda и AWS Gateway**

# Преимущества

- Ни вы, как разра­ботчик, ни кто-нибудь другой в вашей организации не должны волноваться о ка­ких-либо аспектах серверов, виртуальных машин или контейнеров.
- *Интеграция со многими сервисами AWS.* Вы можете с невероятной легкостью писать лямбда-функции, которые потребляют события, сгенерированные такими сервисами AWS, как DynamoDB и Kinesis, и обрабатывают HTTP-запросы через API-шлюз AWS.
- *Избавление от многих задач системного администрирования.* Вы больше не от­вечаете за низкоуровневое системное администрирование. У вас нет операцион­ных систем и сред выполнения, которые нужно обновлять. Благодаря этому вы можете сосредоточиться на развертывании своего приложения.
- *Эластичность.* AWS Lambda запускает экземпляры вашего приложения в ко­личестве, которого достаточно, чтобы справиться с нагрузкой. Вам не нужно предсказывать необходимую пропускную способность или волноваться о недо­статочном или чрезмерном выделении ВМ или контейнеров.
- *Тарифы, основанные на потреблении.* В отличие от типичных облаков IaaS, в ко­торых вы платите за каждую минуту или час работы ваших ВМ или контейнеров (даже когда они простаивают), AWS Lambda берет плату только за ресурсы, по­траченные на обработку каждого запроса.

# Недостатки

- *Периодически возникает высокая латентность.* Поскольку в AWS Lambda ваш код выполняется динамически, некоторые запросы будут демонстрировать высокую латентность. Это связано с тем, что AWS нужно время на создание экземпляра приложения и его запуск. Особенно остра эта проблема в сервисах, написанных на Java, поскольку они обычно запускаются как минимум несколько секунд. В связи с этим AWS Lambda может оказаться не лучшим выбором для сервисов, требующих низкой латентности.
- *Ограниченная модель программирования, основанная на событиях/запросах.* Технология AWS Lambda не предназначена для развертывания длительное время работающих сервисов, которые, к примеру, принимают сообщения от стороннего брокера, такого как RabbitMQ.
- Среда бессерверного развертывания, как правило, имеет гораздо больше ограничений, чем инфраструктура на базе ВМ или контейнеров. Например, AWS Lambda поддерживает только несколько языков. Она подходит только для развертывания приложений без состояния, которые запускаются в ответ на запрос. Вы не сможете развернуть долго работающее приложение с состоянием, такое как база данных или брокер сообщений.