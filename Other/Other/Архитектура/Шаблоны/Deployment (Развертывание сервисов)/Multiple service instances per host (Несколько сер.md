# Multiple service instances per host (Несколько сервисов на одном сервере)

### Проблема

Как упаковать и развернуть сервис?

Представьте, что вам нужно развернуть сервис, написанный на Java с применением Spring Boot. Для этого можно воспользоваться форматом пакетов, предназначенным для определенного языка. При использовании этого подхода пакет развертывается в промышленную среду, а управляет им среда выполнения сервиса. В случае с сервисом это будет исполняемый файл формата JAR или WAR. В других языках, таких как NodeJS, сервис представляет со­бой каталог с исходным кодом и модулями. Такие языки, как GoLang, компилируют сервис в исполняемый файл конкретной операционной системы.

### Решение

Запуск нескольких экземпляров различных сервисов на одном хосте (физической или виртуальной машине). Существуют различные способы развертывания экземпляра службы на общем хосте, в том числе: 

- Развертывание каждого экземпляра сервиса как процесса JVM. Например, по одному экземпляру Tomcat или Jetty на каждый экземпляр сервиса.
- Развертывание нескольких экземпляров сервиса в одной JVM. Например, в виде веб-приложений или пакетов OSGI.

Чтобы развернуть сервис, нужно сначала установить на компьютер необходимую среду выполнения — в данном случае это JDK. Если вы используете WAR-файл, вам также нужно установить веб-контейнер, такой как Apache Tomcat. Подготовив компьютер, вы должны скопировать на него свой пакет и запустить сервис. Каждый экземпляр сервиса выполняется в виде процесса JVM.

В идеале ваш процесс развертывания должен уметь автоматически доставлять сервисы в промышленную среду. Сначала собирается файл формата JAR или WAR. Затем вызывается интерфейс управления сервисами промышленной среды, который развертывает новую версию.

![Untitled](Multiple%20service%20instances%20per%20host%20(%D0%9D%D0%B5%D1%81%D0%BA%D0%BE%D0%BB%D1%8C%D0%BA%D0%BE%20%D1%81%D0%B5%D1%80/Untitled.png)

Экземпляр сервиса обычно (но не всегда) представлен единственным процес­сом. Например, в Java это процесс, в котором выполняется JVM. Сервис на основе NodeJS может породить несколько рабочих процессов для параллельной обработки запросов. Некоторые языки поддерживают развертывание множества экземпляров сервиса в рамках одного процесса.

Иногда компьютер обслуживает лишь один экземпляр сервиса, но при этом вы можете развернуть на нем дополнительные экземпляры. Например, вы можете за­пустить на одном сервере несколько JVM-машин. Каждая JVM-машина выполняет отдельный экземпляр сервиса.

![Untitled](Multiple%20service%20instances%20per%20host%20(%D0%9D%D0%B5%D1%81%D0%BA%D0%BE%D0%BB%D1%8C%D0%BA%D0%BE%20%D1%81%D0%B5%D1%80/Untitled%201.png)

Некоторые языки позволяют запускать несколько экземпляров сервиса в одном процессе. Например, вы можете запустить несколько Java-сервисов в одном контей­нере Apache Tomcat.

![Untitled](Multiple%20service%20instances%20per%20host%20(%D0%9D%D0%B5%D1%81%D0%BA%D0%BE%D0%BB%D1%8C%D0%BA%D0%BE%20%D1%81%D0%B5%D1%80/Untitled%202.png)

Этот подход обычно используют при развертывании кода в традиционных до­рогих и тяжеловесных серверах приложений, таких как WebLogic и WebSphere. Сервисы можно также упаковывать в формате OSGI и запускать по нескольку их экземпляров в каждом OSGI-контейнере.

### Преимущества

- Быстрое развертывание.
Одно из важнейших преимуществ этого подхода состоит в относительно высокой скорости развертывания экземпляров сервиса. Если сервис написан на Java, вы мо­жете просто скопировать файл JAR или WAR. При использовании других языков, таких как NodeJS или Ruby, нужно скопировать исходный код. В любом случае
объем информации, копируемой по сети, получается довольно небольшим.
Кроме того, запуск сервисов обычно не занимает много времени. Если сервис находится в отдельном процессе, вы можете его просто запустить. Если же это один из нескольких экземпляров, размещенных в процессе одного контейнера, у вас есть два варианта: развернуть его динамически или перезапустить весь контейнер. Благодаря отсутствию накладных расходов перезапуск сервиса обычно происходит очень быстро.
- Эффективное задействование ресурсов, особенно при запуске нескольких экзем­пляров на одном компьютере или внутри одного процесса.
Множество экземпляров сервиса находятся на одном ком­пьютере и работают в одной ОС. Эффективность может возрасти еще сильнее, если несколько экземпляров сервиса запустить в одном процессе. Например, разные веб-приложения могут задействовать один и тот же сервер Apache Tomcat и JVM.

### Недостатки

- Отсутствие инкапсуляции стека технологий.
Команде системных администраторов должны быть известны подробности развертывания каждого отдельного сервиса, включая конкретную версию среды вы­полнения. Например, веб-приложению, написанному на Java, нужны определенные версии Apache Tomcat и JDK. Администраторы должны позаботиться об установке подходящих программных пакетов.
Но что еще хуже, сервисы могут быть написаны на разных языках и с примене­нием разных фреймворков. Также они могут использовать разные версии одних и тех же языков и библиотек. Поэтому команда разработчиков должна сообщать администраторам множество подробностей. Ведь, например, на компьютере может быть установлена не та версия среды выполнения.
- Невозможность ограничения ресурсов, потребляемых экземпляром сервиса.
Процесс потенциально может занять все процессорное время или память, отнимая ресурсы у других
экземпляров сервиса и операционной системы. Это может произойти, к примеру, из-за ошибки в коде.
- Недостаточная изоляция при запуске нескольких экземпляров сервиса на одном компьютере.
Проблема усугубляется, когда несколько экземпляров выполняются на одном ком­пьютере. Недостаточная изоляция означает, что один вышедший из строя экземпляр может повлиять на работу других. В итоге приложение может стать ненадежным, особенно при запуске нескольких экземпляров сервиса на одном компьютере.
- Трудности автоматического определения места размещения экземпляров сервиса.
Еще одно затруднение при выполнении нескольких экземпляров сервиса на одном компьютере связано с определением того, где их разместить. Объем процессорного времени, памяти и т. д. у каждого сервера ограничен, и каждому экземпляру сервиса нужна какая-то часть этих ресурсов. Экземпляры сервисов следует размещать так, чтобы они эффективно использовали оборудование и не вызывали перегрузок. Облачные платформы на основе ВМ и фреймворки оркестрации контейнеров делают это автоматически. При развертывании сервисов без каких-либо абстракций вам, скорее всего, придется самостоятельно управлять размещением.

Как видите, привычное применение пакетов для конкретных языков все же имеет существенные недостатки. Вам следует избегать этого подхода, за исключением тех случаев, когда эффективность перевешивает все остальное.