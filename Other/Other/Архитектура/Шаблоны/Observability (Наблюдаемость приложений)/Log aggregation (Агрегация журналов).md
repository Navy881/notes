# Log aggregation (Агрегация журналов)

### Проблема

Как понять поведение приложения и устранить неполадки?

Журналы незаменимы при диагностике. Если вы хотите узнать, что не так с вашим приложением, лучше всего начать с журнальных файлов. Однако ведение журналов в микросервисной архитектуре сопряжено с определенными трудностями. Пред­ ставьте, например, что вы отлаживаете проблемный запрос getOrderDetails(). Как говорилось в главе 8, приложение FTGO реализует его, объединяя API- интерфейсы. В итоге нужные вам журнальные записи оказываются разбросанными между API-шлюзом и несколькими сервисами, включая Order и Kitchen.

### Решение

Агрегирует журналы всех сервисов в центральной базе данных с поддержкой поиска и уведомлений.

Решение состоит в использовании агрегации журналов. Этот процесс отправляет журналы всех сервисов на центральный журнальный сервер. Как только сервер их сохранит, вы сможете их просматривать, искать и анализировать, а также сконфигурировать оповещения, которые срабатывают при появлении в журналах определенного сообщения.

![Untitled](Log%20aggregation%20(%D0%90%D0%B3%D1%80%D0%B5%D0%B3%D0%B0%D1%86%D0%B8%D1%8F%20%D0%B6%D1%83%D1%80%D0%BD%D0%B0%D0%BB%D0%BE%D0%B2)/Untitled.png)

За процесс агрегации и журнальный сервис обычно отвечают системные админи­страторы. А вот написание сервисов, генерирующих осмысленные журналы, ложится на разработчиков.

**Как сервис генерирует журнал**
Вы, как разработчик сервиса, должны позаботиться о нескольких важных моментах.

1. Вам нужно выбрать библиотеку ведения журнала.
В большинстве языков программирования есть одна или несколько библиотек для ведения журналов, которые облегчают генерацию правильно структурированных за­писей. Например, в Java для этого есть три популярных решения: Logback, log4j и JUL (java.util.logging). Можно также вспомнить SLF4J — API для различных журнальных фреймворков. В NodeJS доступен аналогичный фреймворк Log4JS. Один из разумных способов ведения журнала состоит в интеграции вызовов к этим библиотекам в код ваших сервисов. Но если существуют строгие требования к ведению журнала, которые нельзя удовлетворить с помощью сторонних библиотек, вам, возможно, придется на­писать собственный API, который будет служить оберткой для одной из них.
2. Вы должны решить, куда вносить журнальные записи.
Также нужно определиться с тем, куда записывать журнал. Традиционно для этого используется журнальный файл, размещенный в известном всем каталоге. Но в случае работы с современными технологиями развертывания, такими как кон­тейнеры и бессерверные платформы, это будет не лучшим решением. В некоторых средах, таких как AWS Lambda, нет даже такого понятия, как посто­янная файловая система, где можно хранить журнальные записи! Вместо этого ваш сервис должен записывать журнал в stdout, а инфраструктура развертывания будет решать, что делать с выводом сервиса.

**Инфраструктура агрегации журналов**

Инфраструктура ведения журналов отвечает за их агрегацию, хранение и предо­ставление пользователям функции поиска. Популярным решением в этой области является стек ELK. Он состоит из трех продуктов с открытым исходным кодом:

- *Elasticsearch —* база данных типа NoSQL, ориентированная на текстовый поиск. Используется в качестве журнального сервера;
- *Logstash* — конвейер, который агрегирует журналы сервисов и записывает их в Elasticsearch;
- *Kibana —* инструмент визуализации для Elasticsearch.

В качестве примеров других открытых решений для работы с журналами можно привести Fluentd и Apache Flume. В число журнальных сервисов можно включить как облачные сервисы, такие как AWS CloudWatch Logs, так и многочисленные коммерческие продукты. 

### Преимущества

- Агрегация журналов служит полезным инструментом от­ладки в микросервисной архитектуре.

### Недостатки

- Для обработки большого объема журналов требуется значительная инфраструктура.