# Health Check API (API проверки работоспособности)

### Проблема

Как обнаружить, что запущенный экземпляр сервиса не может обрабатывать запросы?

Иногда запущенный сервис не в состоянии обрабатывать запросы. Например, экзем­пляр сервиса может быть не готов принимать запросы сразу после запуска. Скажем, для инициализации адаптеров обмена сообщениями и базы данных сервису Consumer требуется около 10 с. Поэтому инфраструктуре развертывания не следует направ­лять ему HTTP-запросы, пока он не будет в состоянии их обрабатывать.

Кроме того, экземпляр сервиса может дать сбой, не завершая при этом работу. Например, из-за ошибки сервис Consumer может исчерпать доступные соединения с базой данных, в результате чего он будет не способен к ней обращаться. Инфра­структура развертывания не должна направлять запросы экземплярам сервисов, которые дали сбой, но все еще работают. И если такой сервис не восстанавливается, инфраструктура должна его удалить и создать вместо него новый экземпляр.

### Решение

Сервис открывает доступ к конечной точке наподобие GET /health, которая возвращает данные о работоспособности сервиса.

Экземпляр сервиса должен иметь возможность сообщить инфраструктуре развертывания о том, способен ли он обрабатывать запросы. Хорошим решением будет реализация в сервисе конечной точки для проверки работоспособности. Например, Java-библиотека Spring Boot Actuator предоставляет ко­нечную точку GET /actuator/health, которая возвращает коды 200 или 503 в зависимости от состояния сервиса. Для .NET есть аналогичная библиотека Healthchecks, реализующая конечную точку GET /he. Инфраструкту­ра развертывания периодически обращается по соответствующему адресу, чтобы понять, в каком состоянии находится экземпляр сервиса, и принять необходимые меры, если тот оказался неработоспособным.

![Untitled](Health%20Check%20API%20(API%20%D0%BF%D1%80%D0%BE%D0%B2%D0%B5%D1%80%D0%BA%D0%B8%20%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BE%D1%81%D0%BF%D0%BE%D1%81%D0%BE%D0%B1%D0%BD%D0%BE%D1%81%D1%82%D0%B8)/Untitled.png)

Обработчик запросов проверки работоспособности обычно тестирует соединения экземпляра сервиса с внешними компонентами. Он может, к примеру, выполнить тестовый запрос к базе данных. Если все тесты прошли успешно, он возвращает соответствующий ответ, такой как HTTP-код состояния 200. Если любой из них завершится неудачно, ответ будет сигнализировать о плохой работоспособности (например, в виде HTTP-кода состояния 500).

Обработчик запросов проверки работоспособности может просто вернуть пу­стой HTTP-ответ с подходящим кодом или подробно описать работоспособность каждого адаптера. Детальная информация может пригодиться для диагностики. Но поскольку некоторые ее аспекты могут оказаться конфиденциальными, такие фреймворки, как Spring Boot Actuator, позволяют настраивать уровень детализации ответов конечной точки.

При использовании проверок работоспособности следует обратить внимание на два момента.

1. Реализация конечной точки, которая будет отчиты­ваться о состоянии экземпляра сервиса. 
2. Инфраструктура развертывания должна быть сконфигурирована для обращения к этой конечной точке. 

**Реализация конечной точки для проверки работоспособности**

Код, реализующий конечную точку для проверки работоспособности, должен каким-то образом определять состояние экземпляра сервиса. Один из простых подходов заключается в том, чтобы проверять, может ли тот обращаться к внешним компо­нентам. То, как это сделать, зависит от отдельных инфраструктурных сервисов. Например, код проверки работоспособности может получить соединение к СУРБД и выполнить тестовый запрос. Более сложным было бы выполнение синтетической транзакции, которая симулирует вызов API сервиса со стороны клиента. Подобные проверки получаются более глубокими, но обычно требуют больше времени на раз­ работку и выполнение.

Отличный пример библиотеки для проверки работоспособности — Spring Boot Actuator. Она предоставляет конечную точку /actuator/health. Код, реализующий этот вызов, возвращает результат выполнения целого набора проверок. Применяя соглашение о конфигурации, Spring Boot Actuator вы­полняет подходящий набор проверок с учетом того, какие инфраструктурные ком­поненты использует сервис. Например, если сервис работает с объектом Datasource из JDBC, Spring Boot Actuator конфигурирует проверку для выполнения тестового запроса. Точно так же, если сервис задействует брокер сообщений RabbitMQ, он автоматически подготавливает проверку доступности сервера RabbitMQ.

**Обращение к конечной точке проверки работоспособности**

Конечная точка проверки работоспособности окажется практически бесполезной, если ее некому будет вызывать. При развертывании своего сервиса вы должны сконфигу­рировать инфраструктуру так, чтобы она обращалась к его конечной точке. То, как это сделать, зависит от специфики вашей инфраструктуры развертывания. Например, вы можете подготовить реестр сервисов наподобие Netflix Eureka, чтобы тот обращался к конечным точкам для проверки работоспособности и решал, стоит ли направлять трафик к экземпляру сервиса. Можно сконфигурировать Docker и Kubernetes для вызова таких конечных точек.

### Преимущества

- Конечная точка проверки работоспособности позволяет периодически проверять работоспособность экземпляра сервиса.

### Недостатки

- Проверка работоспособности может быть недостаточно полной или экземпляр сервиса может выйти из строя между проверками работоспособности, и тогда запросы будут направляться к отказавшему экземпляру сервиса.